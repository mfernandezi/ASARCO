<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Mensual ASARCO 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2b6cb0;
            --accent: #ed8936;
            --green: #38a169;
            --red: #e53e3e;
            --bg: #f7fafc;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --text: #2d3748;
            --text-light: #718096;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .header p { opacity: 0.85; font-size: 1.1rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        .upload-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px dashed var(--border);
        }
        .upload-section h2 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.2rem;
            margin-bottom: 1.5rem;
        }
        .upload-card {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 1.2rem;
            transition: all 0.3s;
        }
        .upload-card.loaded {
            border-color: var(--green);
            background: #f0fff4;
        }
        .upload-card label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        .upload-card .desc {
            font-size: 0.82rem;
            color: var(--text-light);
            margin-bottom: 0.8rem;
        }
        .upload-card input[type="file"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        .upload-card .status {
            margin-top: 0.5rem;
            font-size: 0.82rem;
            font-weight: 600;
        }
        .status-ok { color: var(--green); }
        .status-err { color: var(--red); }
        .btn {
            display: inline-block;
            padding: 0.8rem 2rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { background: var(--primary-light); transform: translateY(-1px); }
        .btn:disabled { background: #a0aec0; cursor: not-allowed; transform: none; }
        .btn-center { text-align: center; }
        nav {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        nav a {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--bg);
            color: var(--primary);
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }
        nav a:hover { background: var(--primary); color: white; }
        .section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .section-title {
            font-size: 1.3rem;
            color: var(--primary);
            border-bottom: 3px solid var(--accent);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .subtitle {
            font-size: 1.05rem;
            color: var(--primary-light);
            margin: 1.2rem 0 0.6rem 0;
            font-weight: 600;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.88rem;
        }
        th {
            background: var(--primary);
            color: white;
            padding: 0.6rem 0.8rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        th:first-child { text-align: left; border-radius: 8px 0 0 0; }
        th:last-child { border-radius: 0 8px 0 0; }
        td {
            padding: 0.5rem 0.8rem;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        td:first-child { text-align: left; font-weight: 600; }
        tr:hover { background: #edf2f7; }
        tr.total-row { background: #ebf4ff; font-weight: 700; }
        tr.total-row:hover { background: #dbeafe; }
        .positive { color: var(--green); font-weight: 600; }
        .negative { color: var(--red); font-weight: 600; }
        .neutral { color: var(--text-light); }
        .badge {
            display: inline-block;
            padding: 0.15rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .badge-si { background: #c6f6d5; color: #22543d; }
        .badge-no { background: #fed7d7; color: #9b2c2c; }
        .badge-mejor { background: #c6f6d5; color: #22543d; }
        .badge-peor { background: #fed7d7; color: #9b2c2c; }
        .badge-revisar { background: #fefcbf; color: #744210; }
        .badge-ok { background: #c6f6d5; color: #22543d; }
        .badge-estable { background: #e2e8f0; color: #4a5568; }
        .bar-container {
            width: 100%;
            background: #edf2f7;
            border-radius: 6px;
            overflow: hidden;
            height: 22px;
            display: flex;
        }
        .bar {
            height: 100%;
            display: flex;
            align-items: center;
            padding-left: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            min-width: fit-content;
            white-space: nowrap;
            overflow: hidden;
        }
        .bar-efectivo { background: var(--green); }
        .bar-demora { background: var(--accent); }
        .bar-mantencion { background: var(--red); }
        .bar-reserva { background: var(--primary-light); }
        .bar-otro { background: var(--text-light); }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .kpi-card {
            background: var(--bg);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border);
        }
        .kpi-card .value { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
        .kpi-card .label { font-size: 0.8rem; color: var(--text-light); margin-top: 0.2rem; }
        .mes-tab {
            display: inline-block;
            background: var(--primary-light);
            color: white;
            padding: 0.3rem 1rem;
            border-radius: 8px 8px 0 0;
            font-weight: 700;
            font-size: 0.95rem;
            margin-top: 1rem;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 0.8rem 0;
            font-size: 0.82rem;
        }
        .legend-item { display: flex; align-items: center; gap: 0.3rem; }
        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            display: inline-block;
        }
        .footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-light);
            font-size: 0.85rem;
        }
        #results { display: none; }
        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.1rem;
            color: var(--primary-light);
            display: none;
        }
        .loading.active { display: block; }
    </style>
</head>
<body>

<div class="header">
    <h1>Análisis Mensual ASARCO 2026</h1>
    <p>Perforadoras - Reporte Interactivo</p>
</div>

<div class="container">

<div class="upload-section" id="uploadSection">
    <h2>Subir Archivos de Datos</h2>
    <p style="color:var(--text-light); margin-bottom:1.2rem;">Sube los 3 archivos para generar el análisis completo. Todo se procesa en tu navegador, no se sube nada a internet.</p>

    <div class="upload-grid">
        <div class="upload-card" id="card-csv">
            <label>1. Datos UEBD (CSV)</label>
            <div class="desc">Archivo DispUEBD_AllRigs...csv con datos de estado de equipos</div>
            <input type="file" id="file-csv" accept=".csv" onchange="handleFile('csv')">
            <div class="status" id="status-csv"></div>
        </div>
        <div class="upload-card" id="card-mensual">
            <label>2. Mensual 2026 (Excel)</label>
            <div class="desc">Archivo MENSUAL 2026.xlsx con KPIs mensuales reales</div>
            <input type="file" id="file-mensual" accept=".xlsx,.xls" onchange="handleFile('mensual')">
            <div class="status" id="status-mensual"></div>
        </div>
        <div class="upload-card" id="card-plan">
            <label>3. Plan 2025 (Excel)</label>
            <div class="desc">Archivo Planes MENSUALES 2025.xlsx con KPIs planificados</div>
            <input type="file" id="file-plan" accept=".xlsx,.xls" onchange="handleFile('plan')">
            <div class="status" id="status-plan"></div>
        </div>
    </div>
    <div class="btn-center">
        <button class="btn" id="btnAnalizar" disabled onclick="runAnalysis()">Generar Análisis</button>
    </div>
</div>

<div class="loading" id="loading">Procesando datos... por favor espera.</div>
<div id="results"></div>

</div>

<script>
let DATA = { csv: null, mensual: null, plan: null };
const MESES_ORDER = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const INDICES = ['Disponibilidad','Utilización','Rendimiento','Metros','Horas Efectivas'];

function handleFile(type) {
    const input = document.getElementById('file-' + type);
    const status = document.getElementById('status-' + type);
    const card = document.getElementById('card-' + type);
    const file = input.files[0];
    if (!file) return;
    status.textContent = 'Cargando...';
    status.className = 'status';

    if (type === 'csv') {
        Papa.parse(file, {
            header: true, delimiter: ';', skipEmptyLines: true, encoding: 'UTF-8',
            complete: function(res) {
                DATA.csv = res.data;
                status.textContent = 'OK: ' + res.data.length.toLocaleString() + ' registros';
                status.className = 'status status-ok';
                card.classList.add('loaded');
                checkReady();
            },
            error: function(err) {
                status.textContent = 'Error: ' + err.message;
                status.className = 'status status-err';
            }
        });
    } else {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws, { defval: null });
                const rawH = XLSX.utils.sheet_to_json(ws, { header: 1 })[0];
                if (rawH) {
                    const gi = rawH.indexOf('Mayo'), hi = rawH.indexOf('Abril');
                    if (gi !== -1 && hi !== -1 && gi < hi) {
                        json.forEach(r => { const t = r['Mayo']; r['Mayo'] = r['Abril']; r['Abril'] = t; });
                    }
                }
                DATA[type] = json;
                status.textContent = 'OK: ' + json.length + ' filas';
                status.className = 'status status-ok';
                card.classList.add('loaded');
                checkReady();
            } catch (err) {
                status.textContent = 'Error: ' + err.message;
                status.className = 'status status-err';
            }
        };
        reader.readAsArrayBuffer(file);
    }
}

function checkReady() {
    document.getElementById('btnAnalizar').disabled = !(DATA.csv && DATA.mensual && DATA.plan);
}

function runAnalysis() {
    document.getElementById('loading').classList.add('active');
    setTimeout(() => {
        try { processAndRender(); }
        catch(err) { alert('Error: ' + err.message); console.error(err); }
        document.getElementById('loading').classList.remove('active');
    }, 100);
}

function processAndRender() {
    const csv = DATA.csv;
    csv.forEach(r => {
        r._dur = parseFloat(r.Duration) || 0;
        r._h = r._dur / 3600;
        const m = parseInt((r.Time || '').substring(5,7));
        r._mes = m;
        r._mesN = MESES_ORDER[m-1] || ('Mes '+m);
        r._eq = (r.RigName || '').replace(/-/g, '');
        const sc = r.ShortCode;
        if (sc === 'Efectivo') r._cat = 'Efectivo';
        else if (sc === 'Demora') r._cat = 'Demora Operacional';
        else if (sc === 'Reserva') r._cat = 'Reserva';
        else if (sc === 'Mantencion') r._cat = 'Mantención';
        else { const c = parseInt(r.OnlyCodeNumber)||0; r._cat = c>=600&&c<=699?'Demora Op. (BV)':c>=700&&c<=799?'Mantención (NP)':'Otro'; }
    });

    const real = DATA.mensual, plan = DATA.plan;
    const mCD = []; MESES_ORDER.forEach(m => { if(real.some(r => r[m]!=null && r[m]!=='' && !isNaN(r[m]))) mCD.push(m); });
    const allEq = [...new Set(real.map(r=>r.Equipo))].filter(Boolean);
    const eqSinT = allEq.filter(e=>e!=='TOTAL'&&e!=='PFAR');

    function gv(ds,eq,idx,mes){ const r=ds.find(r=>r.Equipo===eq&&(r['Índices']===idx||r.Índices===idx)); if(!r)return null; const v=r[mes]; return(v!=null&&v!==''&&!isNaN(v))?parseFloat(v):null; }
    function fp(v){return(v*100).toFixed(1)+'%';}
    function fn(v,d){d=d||1;return v.toLocaleString('es-CL',{minimumFractionDigits:d,maximumFractionDigits:d});}
    function fi(v){return Math.round(v).toLocaleString('es-CL');}
    function dc(v){return v>0.0001?'positive':v<-0.0001?'negative':'neutral';}
    function dci(v){return v<-0.0001?'positive':v>0.0001?'negative':'neutral';}
    function ar(v){return v>0.0001?'&#9650;':v<-0.0001?'&#9660;':'&#9552;';}
    function ip(i){return i==='Disponibilidad'||i==='Utilización';}

    let h = '';

    // NAV
    h += '<nav><a href="#comp">Comparación Mensual</a><a href="#rvp">Real vs Plan</a><a href="#uebd">Códigos UEBD</a><a href="#disp">Disponibilidad UEBD</a><a href="#dem">Demoras Prog/No Prog</a><a href="#mant">Mantención Detalle</a></nav>';

    // KPI
    const lm=mCD[mCD.length-1],pm=mCD.length>1?mCD[mCD.length-2]:null;
    const dl=gv(real,'TOTAL','Disponibilidad',lm),dp=pm?gv(real,'TOTAL','Disponibilidad',pm):null;
    const ul=gv(real,'TOTAL','Utilización',lm);
    const ml=gv(real,'TOTAL','Metros',lm),mp=pm?gv(real,'TOTAL','Metros',pm):null;
    const rl=gv(real,'TOTAL','Rendimiento',lm);
    h+='<div class="section"><div class="section-title">Resumen KPI - Flota Total</div><div class="kpi-grid">';
    if(dp!==null) h+=`<div class="kpi-card"><div class="value">${fp(dp)}</div><div class="label">Disponibilidad ${pm}</div></div>`;
    if(dl!==null) h+=`<div class="kpi-card"><div class="value">${fp(dl)}</div><div class="label">Disponibilidad ${lm}</div></div>`;
    if(ul!==null) h+=`<div class="kpi-card"><div class="value">${fp(ul)}</div><div class="label">Utilización ${lm}</div></div>`;
    if(ml!==null&&mp!==null) h+=`<div class="kpi-card"><div class="value">${fi(mp+ml)}</div><div class="label">Metros Totales</div></div>`;
    if(rl!==null) h+=`<div class="kpi-card"><div class="value">${fn(rl)}</div><div class="label">Rendimiento ${lm} (m/hr)</div></div>`;
    h+='</div></div>';

    // 1. COMPARACIÓN MENSUAL
    if(mCD.length>=2){
        const mA=mCD[mCD.length-2],mB=mCD[mCD.length-1];
        h+=`<div class="section" id="comp"><div class="section-title">1. Comparación Mensual - ${mA} vs ${mB}</div><p style="color:var(--text-light);margin-bottom:1rem">Comparación directa de cada índice por equipo.</p>`;
        INDICES.forEach(idx=>{
            const ur=real.find(r=>r['Índices']===idx);
            const u=ur?(ur.Unidad||''):'';
            const pc=ip(idx), mt=idx==='Metros';
            h+=`<div class="subtitle">${idx} (${u})</div><table><tr><th>Equipo</th><th>${mA}</th><th>${mB}</th><th>Diferencia</th><th>Var %</th><th></th></tr>`;
            allEq.forEach(eq=>{
                const a=gv(real,eq,idx,mA),b=gv(real,eq,idx,mB);
                if(a===null||b===null) return;
                const d=b-a, vp=a!==0?(d/a*100):0, c=dc(d), it=eq==='TOTAL', rc=it?' class="total-row"':'';
                let aS,bS,dS;
                if(pc){aS=fp(a);bS=fp(b);dS=(d*100>=0?'+':'')+(d*100).toFixed(1)+' pp';}
                else if(mt){aS=fi(a);bS=fi(b);dS=(d>=0?'+':'')+fi(d);}
                else{aS=fn(a);bS=fn(b);dS=(d>=0?'+':'')+fn(d);}
                h+=`<tr${rc}><td>${eq}</td><td>${aS}</td><td>${bS}</td><td class="${c}">${dS}</td><td class="${c}">${vp>=0?'+':''}${vp.toFixed(1)}%</td><td class="${c}">${ar(d)}</td></tr>`;
            });
            h+='</table>';
        });
        h+='</div>';
    }

    // 2. REAL vs PLAN
    h+='<div class="section" id="rvp"><div class="section-title">2. Real 2026 vs Plan 2025 (por Mes)</div><p style="color:var(--text-light);margin-bottom:1rem">Compara el valor real contra el plan del mismo mes.</p>';
    mCD.forEach(mes=>{
        h+=`<div class="mes-tab">${mes.toUpperCase()}</div>`;
        INDICES.forEach(idx=>{
            const ur=real.find(r=>r['Índices']===idx);
            const u=ur?(ur.Unidad||''):'';
            const pc=ip(idx), mt=idx==='Metros';
            h+=`<div class="subtitle">${idx} (${u})</div><table><tr><th>Equipo</th><th>Plan 2025</th><th>Real 2026</th><th>Diferencia</th><th>Cumple</th></tr>`;
            [...eqSinT,'PFAR','TOTAL'].forEach(eq=>{
                const rv=gv(real,eq,idx,mes),pv=gv(plan,eq,idx,mes);
                if(rv===null||pv===null) return;
                const d=rv-pv, cu=d>=-0.0001, c=dc(d), it=eq==='TOTAL', rc=it?' class="total-row"':'';
                let pvS,rvS,dS;
                if(pc){pvS=fp(pv);rvS=fp(rv);dS=(d*100>=0?'+':'')+(d*100).toFixed(1)+' pp';}
                else if(mt){pvS=fi(pv);rvS=fi(rv);dS=(d>=0?'+':'')+fi(d);}
                else{pvS=fn(pv);rvS=fn(rv);dS=(d>=0?'+':'')+fn(d);}
                const bg=cu?'<span class="badge badge-si">SI</span>':'<span class="badge badge-no">NO</span>';
                h+=`<tr${rc}><td>${eq}</td><td>${pvS}</td><td>${rvS}</td><td class="${c}">${dS}</td><td>${bg}</td></tr>`;
            });
            h+='</table>';
        });
    });
    h+='</div>';

    // 3. CÓDIGOS UEBD
    const ct={};let tH=0;
    csv.forEach(r=>{ct[r._cat]=(ct[r._cat]||0)+r._h;tH+=r._h;});
    const cs=Object.entries(ct).sort((a,b)=>b[1]-a[1]);
    const cc={'Efectivo':'bar-efectivo','Demora Operacional':'bar-demora','Mantención':'bar-mantencion','Reserva':'bar-reserva','Demora Op. (BV)':'bar-otro','Mantención (NP)':'bar-mantencion','Otro':'bar-otro'};

    h+='<div class="section" id="uebd"><div class="section-title">3. Análisis de Códigos UEBD</div>';
    h+='<div class="subtitle">Distribución Global de Horas por Categoría</div>';
    h+='<div class="legend"><div class="legend-item"><span class="legend-dot" style="background:#38a169"></span> Efectivo</div><div class="legend-item"><span class="legend-dot" style="background:#ed8936"></span> Demora Operacional</div><div class="legend-item"><span class="legend-dot" style="background:#e53e3e"></span> Mantención</div><div class="legend-item"><span class="legend-dot" style="background:#2b6cb0"></span> Reserva</div></div>';
    h+='<div style="margin-bottom:1rem"><div class="bar-container" style="height:36px">';
    cs.forEach(([cat,hrs])=>{const p=hrs/tH*100,cx=cc[cat]||'bar-otro';if(p>3)h+=`<div class="bar ${cx}" style="width:${p}%">${cat} ${p.toFixed(1)}%</div>`;else if(p>0.3)h+=`<div class="bar ${cx}" style="width:${p}%">${p.toFixed(1)}%</div>`;});
    h+='</div></div>';
    h+='<table><tr><th>Categoría</th><th>Horas</th><th>% Total</th><th>Barra</th></tr>';
    cs.forEach(([cat,hrs])=>{const p=hrs/tH*100,cx=cc[cat]||'bar-otro';h+=`<tr><td>${cat}</td><td>${fn(hrs)}</td><td>${p.toFixed(1)}%</td><td><div class="bar-container"><div class="bar ${cx}" style="width:${p}%">${p.toFixed(1)}%</div></div></td></tr>`;});
    h+=`<tr class="total-row"><td>TOTAL</td><td>${fn(tH)}</td><td>100.0%</td><td></td></tr></table>`;

    // Top 15
    const cm={};let tNE=0;
    csv.forEach(r=>{if(r.ShortCode==='Efectivo')return;const k=r.OnlyCodeNumber+'|'+r.OnlyCodeName+'|'+r._cat;if(!cm[k])cm[k]={n:r.OnlyCodeNumber,nm:r.OnlyCodeName,ct:r._cat,h:0,c:0};cm[k].h+=r._h;cm[k].c++;tNE+=r._h;});
    const tc=Object.values(cm).sort((a,b)=>b.h-a.h).slice(0,15);
    h+='<div class="subtitle">Top 15 Códigos de Demora (Mayor Impacto)</div><table><tr><th>Código</th><th>Nombre</th><th>Categoría</th><th>Horas</th><th>% Demoras</th><th>N</th><th>Impacto</th></tr>';
    tc.forEach(c=>{const p=c.h/tNE*100,cx=cc[c.ct]||'bar-otro';h+=`<tr><td style="text-align:center">${c.n}</td><td>${c.nm}</td><td>${c.ct}</td><td>${fn(c.h)}</td><td>${p.toFixed(1)}%</td><td>${fi(c.c)}</td><td><div class="bar-container"><div class="bar ${cx}" style="width:${Math.min(p*3,100)}%">${p.toFixed(1)}%</div></div></td></tr>`;});
    h+='</table></div>';

    // 4. DISPONIBILIDAD UEBD
    const csvM=[...new Set(csv.map(r=>r._mes))].sort((a,b)=>a-b);
    h+='<div class="section" id="disp"><div class="section-title">4. Disponibilidad: UEBD vs Reporte</div><p style="color:var(--text-light);margin-bottom:1rem">Disponibilidad = (Total Hrs - Mantención) / Total Hrs</p>';
    csvM.forEach(mn=>{
        const mN=MESES_ORDER[mn-1];
        h+=`<div class="mes-tab">${mN.toUpperCase()}</div><table><tr><th>Equipo</th><th>Hrs Total</th><th>Hrs Mant</th><th>Disp UEBD</th><th>Disp Reporte</th><th>Diferencia</th><th>Estado</th></tr>`;
        const md=csv.filter(r=>r._mes===mn);
        [...new Set(md.map(r=>r._eq))].sort().forEach(eq=>{
            const ed=md.filter(r=>r._eq===eq);
            const thr=ed.reduce((s,r)=>s+r._h,0);
            const mhr=ed.filter(r=>r._cat==='Mantención'||r._cat==='Mantención (NP)').reduce((s,r)=>s+r._h,0);
            const du=thr>0?(thr-mhr)/thr:0;
            const dr=gv(real,eq,'Disponibilidad',mN);
            const dp=dr!==null?(du-dr)*100:null;
            const drS=dr!==null?fp(dr):'N/A';
            const dpS=dp!==null?(dp>=0?'+':'')+dp.toFixed(1)+' pp':'N/A';
            const cl=dp!==null?dc(dp):'neutral';
            let bg='';if(dp!==null)bg=Math.abs(dp)<2?'<span class="badge badge-ok">OK</span>':'<span class="badge badge-revisar">Revisar</span>';
            h+=`<tr><td>${eq}</td><td>${fn(thr)}</td><td>${fn(mhr)}</td><td>${fp(du)}</td><td>${drS}</td><td class="${cl}">${dpS}</td><td>${bg}</td></tr>`;
        });
        h+='</table>';
    });
    h+='</div>';

    // 5. DEMORAS PROG vs NO PROG
    h+='<div class="section" id="dem"><div class="section-title">5. Demoras Programadas vs No Programadas</div><p style="color:var(--text-light);margin-bottom:1rem">Distribución del tiempo por tipo de planificación.</p>';
    csvM.forEach(mn=>{
        const mN=MESES_ORDER[mn-1];
        h+=`<div class="mes-tab">${mN.toUpperCase()}</div><table><tr><th>Equipo</th><th>Programada (h)</th><th>No Programada (h)</th><th>No Asignado (h)</th><th>% No Prog</th><th>Distribución</th></tr>`;
        const md=csv.filter(r=>r._mes===mn);
        [...new Set(md.map(r=>r._eq))].sort().forEach(eq=>{
            const ed=md.filter(r=>r._eq===eq);
            let pr=0,np=0,na=0;
            ed.forEach(r=>{const p=r.PlannedCodeName;if(p==='Programada')pr+=r._h;else if(p==='No Programada')np+=r._h;else na+=r._h;});
            const t=pr+np+na,pp=t>0?pr/t*100:0,pn=t>0?np/t*100:0,pa=t>0?na/t*100:0;
            const bh=`<div class="bar-container"><div class="bar bar-efectivo" style="width:${pp}%">${pp>=5?pp.toFixed(0)+'%':''}</div><div class="bar bar-mantencion" style="width:${pn}%">${pn>=5?pn.toFixed(0)+'%':''}</div><div class="bar bar-reserva" style="width:${pa}%">${pa>=5?pa.toFixed(0)+'%':''}</div></div>`;
            h+=`<tr><td>${eq}</td><td>${fn(pr)}</td><td>${fn(np)}</td><td>${fn(na)}</td><td>${pn.toFixed(1)}%</td><td>${bh}</td></tr>`;
        });
        h+='</table><div class="legend" style="margin-bottom:1.5rem"><div class="legend-item"><span class="legend-dot" style="background:#38a169"></span> Programada</div><div class="legend-item"><span class="legend-dot" style="background:#e53e3e"></span> No Programada</div><div class="legend-item"><span class="legend-dot" style="background:#2b6cb0"></span> No Asignado</div></div>';
    });
    h+='</div>';

    // 6. MANTENCIÓN DETALLE
    h+='<div class="section" id="mant"><div class="section-title">6. Detalle de Mantención por Equipo y Código</div><p style="color:var(--text-light);margin-bottom:1rem">Desglose de horas de mantención por código, comparando mes a mes.</p>';
    const mD=csv.filter(r=>r._cat==='Mantención'||r._cat==='Mantención (NP)');
    [...new Set(mD.map(r=>r._eq))].sort().forEach(eq=>{
        h+=`<div class="subtitle">${eq}</div><table><tr><th>Código</th><th>Nombre</th>`;
        csvM.forEach(m=>{h+=`<th>Hrs ${MESES_ORDER[m-1]}</th>`;});
        h+='<th>Diferencia</th><th>Tipo</th><th>Impacto</th></tr>';
        const em=mD.filter(r=>r._eq===eq);
        const cg={};
        em.forEach(r=>{const k=r.OnlyCodeNumber+'|'+r.OnlyCodeName+'|'+r.PlannedCodeName;if(!cg[k])cg[k]={n:r.OnlyCodeNumber,nm:r.OnlyCodeName,pl:r.PlannedCodeName,bm:{}};cg[k].bm[r._mes]=(cg[k].bm[r._mes]||0)+r._h;});
        Object.values(cg).sort((a,b)=>{const ta=Object.values(a.bm).reduce((s,v)=>s+v,0),tb=Object.values(b.bm).reduce((s,v)=>s+v,0);return tb-ta;}).forEach(c=>{
            h+=`<tr><td style="text-align:center">${c.n}</td><td>${c.nm}</td>`;
            const vs=csvM.map(m=>c.bm[m]||0);
            vs.forEach(v=>{h+=`<td>${fn(v)}</td>`;});
            const d=vs.length>=2?vs[vs.length-1]-vs[vs.length-2]:0;
            const cl=dci(d);
            let bg;if(d<-5)bg='<span class="badge badge-mejor">Mejor</span>';else if(d>5)bg='<span class="badge badge-peor">Peor</span>';else bg='<span class="badge badge-estable">Estable</span>';
            h+=`<td class="${cl}">${d>=0?'+':''}${fn(d)}</td><td>${c.pl}</td><td>${bg}</td></tr>`;
        });
        h+='</table>';
    });
    h+='</div>';

    const now=new Date();
    h+=`<div class="footer">Reporte generado el ${now.toLocaleDateString('es-CL')} ${now.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'})} | ASARCO Perforadoras</div>`;

    document.getElementById('results').innerHTML = h;
    document.getElementById('results').style.display = 'block';
    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
}
</script>
</body>
</html>
